<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur de Pr√©sence au Bureau</title>
    <!-- MODIFI√â : Ic√¥ne pour l'onglet du navigateur (favicon) -->
    <link rel="icon" href="Gemini_Generated_Image_ek04smek04smek04.png">
    <!-- Utilisation de Tailwind CSS pour un design rapide et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Police personnalis√©e pour une meilleure lisibilit√© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .desk {
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, color 0.3s ease-in-out;
            min-height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #refresh-button {
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- En-t√™te de l'application -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Plan de Pr√©sence au Bureau de la ligne Logistique</h1>
            <p class="mt-2 text-lg text-slate-600">S√©lectionnez une date pour voir qui est pr√©sent.</p>
            <p class="text-sm text-slate-500 mt-2">Note : Les modifications apport√©es au Google Sheet peuvent prendre jusqu'√† 5 minutes pour appara√Ætre.</p>
            <!-- <p id="last-refresh-time" class="text-sm text-slate-500 mt-1"></p> -->
            <!-- <p id="g1-update-date" class="text-sm text-slate-500 mt-1"></p> -->
            
        </header>

        <!-- Section des contr√¥les et l√©gende -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-6 mb-8">
            <div class="flex justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <button id="prev-day-button" title="Jour pr√©c√©dent" class="p-2.5 rounded-md bg-white shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-slate-600"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                    </button>
                    <div class="relative rounded-md shadow-sm">
                        <label for="date-filter" class="absolute -top-3 left-2 inline-block bg-slate-50 px-1 text-sm font-medium text-slate-700">Date</label>
                        <input type="date" id="date-filter" class="block w-full rounded-md border-0 py-2.5 px-4 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>
                    <button id="next-day-button" title="Jour suivant" class="p-2.5 rounded-md bg-white shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-slate-600"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <button id="refresh-button" class="inline-flex items-center justify-center gap-x-2 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201-4.42 5.5 5.5 0 0 1 1.023-2.025A5.5 5.5 0 0 1 10 3a5.5 5.5 0 0 1 5.5 5.5c0 1.258-.413 2.41-1.115 3.324l-1.073-1.073a3.5 3.5 0 1 0-4.95-4.95l-1.073-1.073a5.5 5.5 0 1 1 7.778 7.778zM10 18a.75.75 0 0 1-.75-.75V11a.75.75 0 0 1 1.5 0v6.25A.75.75 0 0 1 10 18z" clip-rule="evenodd" /></svg>
                    Rafra√Æchir
                </button>
            </div>

            <!-- MODIFI√â : L√©gende des couleurs simplifi√©e -->
            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-sm text-slate-700">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-emerald-400 mr-2 border border-emerald-500"></span><span>Pr√©sent üßë‚Äçüíª</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-slate-300 mr-2 border border-slate-400"></span><span>Non pr√©sent ü™ë</span></div>
            </div>
        </div>

        <main id="seating-plan" class="grid gap-2 sm:gap-3">
            <div id="loader-container" class="col-span-full text-center p-8">
                <div id="loader"></div>
                <p class="text-slate-600">Chargement des donn√©es...</p>
            </div>
        </main>
    </div>

    <!-- Structure de la popup (modal) - D√©sactiv√©e
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-slate-800" id="modal-title">Modifier la pr√©sence</h3>
            <p class="mt-2 text-sm text-slate-600" id="modal-text"></p>
            <p class="mt-4 text-xs text-slate-500">Pour des raisons de s√©curit√©, l'√©criture directe dans le fichier n'est pas possible depuis cette page. Cliquez sur le bouton pour ouvrir Google Sheets.</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-close-button" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200">Annuler</button>
                <a id="modal-edit-link" href="#" target="_blank" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Ouvrir Google Sheets</a>
            </div>
        </div>
    </div>
    -->

    <script>
        // --- CONFIGURATION ---
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQIQlc7LfYaZdaB9FWT2I5Sq4cqGSpIoc77ola369bELlsLb1ziEFuKSAPOjJPyLkk8UQojXrUG4fH/pub?gid=1264042606&single=true&output=csv';
        const googleSheetEditUrl = 'https://docs.google.com/spreadsheets/d/1frF7xYxU_f4jusfg0NeJE81o74m20f-QwypUGXd6NHk/edit';

        // --- PLAN DU BUREAU ---
        const officeGrid = [
            ['A1', 'A2', 'A3'], ['B1', 'B2', 'B3'], [null, null, null],
            ['C1', 'C2', 'C3'], ['D1', 'D2', 'D3'], [null, null, null],
            ['E1', 'E2', 'E3'], ['F1', 'F2', 'F3'], [null, null, null],
            ['G1', 'G2', 'G3'], ['H1', 'H2', 'H3'], [null, null, null],
            ['I1', 'I2', 'I3'], ['J1', 'J2', 'J3'], [null, null, null],
            ['K1', 'K2', 'K3'], ['L1', 'L2', 'L3']
        ];

        let employeeData = [];
        let g1UpdateDate = '';

        // --- √âL√âMENTS DU DOM ---
        const dateFilter = document.getElementById('date-filter');
        const seatingPlan = document.getElementById('seating-plan');
        const loaderContainer = document.getElementById('loader-container');
        const refreshButton = document.getElementById('refresh-button');
        // const lastRefreshTimeElement = document.getElementById('last-refresh-time'); // Masqu√©
        // const g1UpdateDateElement = document.getElementById('g1-update-date'); // Masqu√©
        const prevDayButton = document.getElementById('prev-day-button');
        const nextDayButton = document.getElementById('next-day-button');
        const originalRefreshButtonContent = refreshButton.innerHTML;

        /* Code de la popup d√©sactiv√©
        const modal = document.getElementById('edit-modal');
        const modalContent = document.getElementById('modal-content');
        const modalText = document.getElementById('modal-text');
        const modalEditLink = document.getElementById('modal-edit-link');
        const modalCloseButton = document.getElementById('modal-close-button');
        */

        // --- FONCTIONS ---
        /*
        function updateLastRefreshDisplay() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            if (lastRefreshTimeElement) lastRefreshTimeElement.textContent = `Derni√®re actualisation : ${now.toLocaleDateString('fr-FR', options)}`;
        }
        
        function updateG1DateDisplay() {
            if (!g1UpdateDate) {
                if(g1UpdateDateElement) g1UpdateDateElement.textContent = '';
                return;
            }
            const parts = g1UpdateDate.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{1,2}))?/);
            let formattedDate = g1UpdateDate;
            if (parts) {
                const [, day, month, year, hour, minute] = parts;
                const dateObj = new Date(year, month - 1, day, hour || 0, minute || 0);
                if (!isNaN(dateObj.getTime())) {
                    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: hour ? '2-digit' : undefined, minute: minute ? '2-digit' : undefined };
                    formattedDate = dateObj.toLocaleDateString('fr-FR', options);
                }
            }
            if (g1UpdateDateElement) g1UpdateDateElement.textContent = `Date de traitement MAJ : ${formattedDate}`;
        }
        */
        
        async function fetchAndProcessData() {
            try {
                const urlWithCacheBust = `${googleSheetCsvUrl}&_=${Date.now()}`;
                const response = await fetch(urlWithCacheBust, { cache: 'no-store' });
                if (!response.ok) throw new Error('Erreur r√©seau.');
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => row.trim().split(','));

                g1UpdateDate = rows[0]?.[6]?.trim() || '';

                const employeeMap = new Map();
                rows.slice(1).forEach(row => {
                    const name = row[0]?.trim();
                    const seat = row[1]?.trim();
                    if (!name || !seat) return;

                    if (!employeeMap.has(name)) {
                        employeeMap.set(name, { id: employeeMap.size + 1, name, seat, presences: {} });
                    }
                    employeeMap.get(name).seat = seat;

                    const date = row[2]?.trim();
                    const status = row[3]?.trim().toLowerCase();
                    if (date && status) {
                        const parts = date.split('/');
                        if (parts.length === 3) {
                            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            employeeMap.get(name).presences[formattedDate] = status;
                        }
                    }
                });
                employeeData = Array.from(employeeMap.values());
                return true;
            } catch (error) {
                console.error("Erreur de chargement :", error);
                seatingPlan.innerHTML = `<p class="col-span-full text-center text-red-600 font-semibold">Erreur: Impossible de charger les donn√©es.</p>`;
                return false;
            }
        }

        function updatePlan(selectedDate) {
            seatingPlan.innerHTML = '';
            const maxColumns = officeGrid.reduce((max, row) => Math.max(max, row.length), 0);
            if (maxColumns === 0) return;
            seatingPlan.style.gridTemplateColumns = `repeat(${maxColumns}, minmax(0, 1fr))`;

            officeGrid.flat().forEach(seatId => {
                if (seatId === null) {
                    const spacer = document.createElement('div');
                    spacer.style.visibility = 'hidden';
                    seatingPlan.appendChild(spacer);
                } else {
                    const employee = employeeData.find(e => e.seat === seatId);
                    const deskElement = document.createElement('div');
                    deskElement.classList.add('desk', 'p-2', 'rounded-lg', 'shadow-md');

                    if (employee) {
                        const status = employee.presences[selectedDate];
                        let colorClasses = 'bg-slate-300 text-slate-600 border-2 border-slate-400'; // Absent
                        let emoji = 'ü™ë'; // Emoji pour absent
                        
                        if (status === 'bureau' || status === 'pr√©sent') {
                            colorClasses = 'bg-emerald-400 text-emerald-900 border-2 border-emerald-500'; // Pr√©sent
                            emoji = 'üßë‚Äçüíª'; // Emoji pour pr√©sent
                        }
                        
                        deskElement.classList.add(...colorClasses.split(' '));
                        // MODIFI√â : Ajout de l'√©moji
                        deskElement.innerHTML = `<span class="font-bold text-base mt-1">${emoji} ${employee.name}</span>`;
                        
                    } else {
                        deskElement.classList.add('bg-white', 'text-slate-400', 'border-2', 'border-dashed', 'border-slate-300');
                        deskElement.innerHTML = `<span class="font-medium">${seatId}</span><span class="text-sm mt-1">Libre</span>`;
                    }
                    seatingPlan.appendChild(deskElement);
                }
            });
        }
        
        /* Fonction de la popup d√©sactiv√©e
        function openEditModal(employee, date) {
            const dateObj = new Date(date + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            modalText.textContent = `Modifier le statut de ${employee.name} pour le ${formattedDate}.`;
            modalEditLink.href = googleSheetEditUrl;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        */

        async function handleRefresh() {
            refreshButton.disabled = true;
            refreshButton.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Chargement...`;
            if (await fetchAndProcessData()) {
                updatePlan(dateFilter.value);
                // updateLastRefreshDisplay(); // Masqu√©
                // updateG1DateDisplay(); // Masqu√©
            }
            refreshButton.disabled = false;
            refreshButton.innerHTML = `Actualis√© ‚úì`;
            refreshButton.classList.replace('bg-indigo-600', 'bg-emerald-600');
            setTimeout(() => {
                refreshButton.innerHTML = originalRefreshButtonContent;
                refreshButton.classList.replace('bg-emerald-600', 'bg-indigo-600');
            }, 2000); 
        }

        function changeDate(days) {
            const currentDate = new Date(dateFilter.value + 'T12:00:00');
            currentDate.setDate(currentDate.getDate() + days);
            const newDateString = currentDate.toISOString().split('T')[0];
            dateFilter.value = newDateString;
            localStorage.setItem('selectedDate', newDateString); 
            updatePlan(newDateString);
        }

        // --- √âV√âNEMENTS ---
        prevDayButton.addEventListener('click', () => changeDate(-1));
        nextDayButton.addEventListener('click', () => changeDate(1));
        refreshButton.addEventListener('click', handleRefresh);
        dateFilter.addEventListener('change', (event) => {
            updatePlan(event.target.value);
            localStorage.setItem('selectedDate', event.target.value); 
        });
        
        /* √âv√©nements de la popup d√©sactiv√©s
        modalCloseButton.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        */

        document.addEventListener('DOMContentLoaded', async () => {
            loaderContainer.style.display = 'block';
            seatingPlan.style.display = 'none';
            if (await fetchAndProcessData()) {
                const savedDate = localStorage.getItem('selectedDate');
                const initialDate = savedDate || new Date().toISOString().split('T')[0];
                dateFilter.value = initialDate;
                updatePlan(initialDate);
                // updateLastRefreshDisplay(); // Masqu√©
                // updateG1DateDisplay(); // Masqu√©
            }
            loaderContainer.style.display = 'none';
            seatingPlan.style.display = 'grid';
            setInterval(() => { location.reload(); }, 3600000);
        });
    </script>
</body>
</html>

