<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur de Pr√©sence au Bureau</title>
    <!-- MODIFI√â : Ic√¥ne pour l'onglet du navigateur (favicon) -->
    <link rel="icon" href="Gemini_Generated_Image_ek04smek04smek04.png">
    <!-- Utilisation de Tailwind CSS pour un design rapide et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Police personnalis√©e pour une meilleure lisibilit√© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .desk {
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, color 0.3s ease-in-out;
            min-height: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #refresh-button {
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-screen-xl mx-auto">
        <!-- En-t√™te de l'application -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Plan de Pr√©sence au Bureau de la ligne Logistique</h1>
            <p class="mt-2 text-lg text-slate-600">S√©lectionnez une date pour voir qui est pr√©sent.</p>
            <!-- <p class="text-sm text-slate-500 mt-2">Note : Les modifications apport√©es au Google Sheet peuvent prendre jusqu'√† 5 minutes pour appara√Ætre.</p> -->
            <p class="text-sm text-slate-500 mt-1">La synchronisation des donn√©es se fait tous les jours √† 5h.</p>
            
        </header>

        <!-- Section des contr√¥les et l√©gende -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-6 mb-8">
            <div class="flex justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <button id="prev-day-button" title="Jour pr√©c√©dent" class="p-2.5 rounded-md bg-white shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-slate-600"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                    </button>
                    <div class="relative rounded-md shadow-sm">
                        <label for="date-filter" class="absolute -top-3 left-2 inline-block bg-slate-50 px-1 text-sm font-medium text-slate-700">Date</label>
                        <input type="date" id="date-filter" class="block w-full rounded-md border-0 py-2.5 px-4 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>
                    <button id="next-day-button" title="Jour suivant" class="p-2.5 rounded-md bg-white shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-slate-600"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <button id="refresh-button" class="inline-flex items-center justify-center gap-x-2 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201-4.42 5.5 5.5 0 0 1 1.023-2.025A5.5 5.5 0 0 1 10 3a5.5 5.5 0 0 1 5.5 5.5c0 1.258-.413 2.41-1.115 3.324l-1.073-1.073a3.5 3.5 0 1 0-4.95-4.95l-1.073-1.073a5.5 5.5 0 1 1 7.778 7.778zM10 18a.75.75 0 0 1-.75-.75V11a.75.75 0 0 1 1.5 0v6.25A.75.75 0 0 1 10 18z" clip-rule="evenodd" /></svg>
                    Rafra√Æchir
                </button>
            </div>

            <!-- L√âGENDE MISE √Ä JOUR : Blocs arrondis et contenu centr√© -->
            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-sm text-slate-700">
                <div class="flex items-center">
                    <span class="w-12 h-8 rounded-lg bg-emerald-400 mr-2 border border-emerald-500 flex items-center justify-center text-xl">üßë‚Äçüíª</span>
                    <span>Pr√©sent</span>
                </div>
                <div class="flex items-center">
                    <span class="w-12 h-8 rounded-lg bg-slate-300 mr-2 border border-slate-400 flex items-center justify-center text-xl">ü™ë</span>
                    <span>Non pr√©sent</span>
                </div>
            </div>
        </div>

        <!-- MODIFI√â : Nouvelle structure principale avec grille pour le plan et colonne lat√©rale -->
        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div id="seating-plan" class="lg:col-span-3 grid gap-2 sm:gap-3">
                <div id="loader-container" class="col-span-full text-center p-8">
                    <div id="loader"></div>
                    <p class="text-slate-600">Chargement des donn√©es...</p>
                </div>
            </div>
            <div id="no-desk-area" class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-slate-700 mb-4 text-center border-b pb-3">SBF</h2>
                <div id="no-desk-list" class="space-y-3">
                    <!-- La liste des personnes sans bureau sera g√©n√©r√©e ici -->
                </div>
            </div>
        </main>
    </div>

    <!-- Pied de page avec copyright -->
    <footer class="text-center mt-12 mb-4">
        <p class="text-sm text-slate-500">&copy; <span id="copyright-year"></span> Ligne Logistique. Tous droits r√©serv√©s.</p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQIQlc7LfYaZdaB9FWT2I5Sq4cqGSpIoc77ola369bELlsLb1ziEFuKSAPOjJPyLkk8UQojXrUG4fH/pub?gid=1264042606&single=true&output=csv';
        
        // --- PLAN DU BUREAU ---
        const officeGrid = [
            ['A1', 'A2', 'A3'], ['B1', 'B2', 'B3'],
            ['corridor'],
            ['C1', 'C2', 'C3'], ['D1', 'D2', 'D3'],
            ['corridor'],
            ['E1', 'E2', 'E3'], ['F1', 'F2', 'F3'],
            ['corridor'],
            ['G1', 'G2', 'G3'], ['H1', 'H2', 'H3'],
            ['corridor'],
            ['I1', 'I2', 'I3'], ['J1', 'J2', 'J3'],
            ['corridor'],
            ['K1', 'K2', 'K3'], ['L1', 'L2', 'L3']
        ];

        // MODIFI√â : Listes s√©par√©es pour les employ√©s avec et sans bureau
        let employeesWithDesk = [];
        let employeesWithoutDesk = [];

        // --- √âL√âMENTS DU DOM ---
        const dateFilter = document.getElementById('date-filter');
        const seatingPlan = document.getElementById('seating-plan');
        const loaderContainer = document.getElementById('loader-container');
        const refreshButton = document.getElementById('refresh-button');
        const prevDayButton = document.getElementById('prev-day-button');
        const nextDayButton = document.getElementById('next-day-button');
        const noDeskList = document.getElementById('no-desk-list');
        const originalRefreshButtonContent = refreshButton.innerHTML;

        
        // --- FONCTIONS ---
        
        async function fetchAndProcessData() {
            try {
                const urlWithCacheBust = `${googleSheetCsvUrl}&_=${Date.now()}`;
                const response = await fetch(urlWithCacheBust, { cache: 'no-store' });
                if (!response.ok) throw new Error('Erreur r√©seau.');
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => row.trim().split(','));

                const employeeMap = new Map();
                rows.slice(1).forEach(row => {
                    const name = row[0]?.trim();
                    if (!name) return; // Ignore les lignes sans nom

                    const seat = row[1]?.trim();
                    const date = row[2]?.trim();
                    const status = row[4]?.trim().toLowerCase();

                    if (!employeeMap.has(name)) {
                        employeeMap.set(name, { id: employeeMap.size + 1, name, seat: seat || null, presences: {} });
                    }
                    
                    const employeeEntry = employeeMap.get(name);
                    if (seat && !employeeEntry.seat) {
                        employeeEntry.seat = seat;
                    }

                    if (date && status) {
                        const parts = date.split('/');
                        if (parts.length === 3) {
                            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            employeeEntry.presences[formattedDate] = status;
                        }
                    }
                });
                
                const allEmployees = Array.from(employeeMap.values());
                employeesWithDesk = allEmployees.filter(e => e.seat);
                employeesWithoutDesk = allEmployees.filter(e => !e.seat);

                return true;
            } catch (error) {
                console.error("Erreur de chargement :", error);
                seatingPlan.innerHTML = `<p class="col-span-full text-center text-red-600 font-semibold">Erreur: Impossible de charger les donn√©es.</p>`;
                return false;
            }
        }

        function updatePlan(selectedDate) {
            seatingPlan.innerHTML = '';
            const maxColumns = officeGrid.reduce((max, row) => (Array.isArray(row) && row.length > 1) ? Math.max(max, row.length) : max, 0);

            if (maxColumns === 0) return;
            seatingPlan.style.gridTemplateColumns = `repeat(${maxColumns}, minmax(0, 1fr))`;

            officeGrid.forEach(row => {
                if (Array.isArray(row) && row.length === 1 && row[0] === 'corridor') {
                    const corridorElement = document.createElement('div');
                    corridorElement.style.gridColumn = `1 / ${maxColumns + 1}`;
                    corridorElement.className = 'h-3 bg-slate-200 rounded-full my-1';
                    seatingPlan.appendChild(corridorElement);
                } else if (Array.isArray(row)) {
                    row.forEach(seatId => {
                        const employee = employeesWithDesk.find(e => e.seat === seatId);
                        const deskElement = document.createElement('div');
                        deskElement.classList.add('desk', 'p-2', 'rounded-lg', 'shadow-md');

                        if (employee) {
                            const status = employee.presences[selectedDate];
                            const isPresent = status === 'true';
                            const colorClasses = isPresent ? 'bg-emerald-400 text-emerald-900 border-2 border-emerald-500' : 'bg-slate-300 text-slate-600 border-2 border-slate-400';
                            const emoji = isPresent ? 'üßë‚Äçüíª' : 'ü™ë';
                            
                            deskElement.classList.add(...colorClasses.split(' '));
                            deskElement.innerHTML = `<span class="font-bold text-base mt-1">${emoji} ${employee.name}</span>`;
                        } else {
                            deskElement.classList.add('bg-white', 'text-slate-400', 'border-2', 'border-dashed', 'border-slate-300');
                            deskElement.innerHTML = `<span class="font-medium">${seatId}</span><span class="text-sm mt-1">Libre</span>`;
                        }
                        seatingPlan.appendChild(deskElement);
                    });
                    for (let i = row.length; i < maxColumns; i++) {
                        seatingPlan.appendChild(document.createElement('div'));
                    }
                }
            });
        }

        // MODIFI√â : Nouvelle fonction pour mettre √† jour la liste des personnes sans bureau
        function updateNoDeskList(selectedDate) {
            noDeskList.innerHTML = '';
            if (employeesWithoutDesk.length === 0) {
                noDeskList.innerHTML = `<p class="text-sm text-slate-500 text-center italic">Aucune personne sans bureau fixe.</p>`;
                return;
            }

            employeesWithoutDesk.forEach(employee => {
                const status = employee.presences[selectedDate];
                const isPresent = status === 'true';
                const bgColor = isPresent ? 'bg-emerald-100' : 'bg-slate-100';
                const textColor = isPresent ? 'text-emerald-900' : 'text-slate-700';
                const emoji = isPresent ? 'üßë‚Äçüíª' : 'ü™ë';

                const personElement = document.createElement('div');
                personElement.className = `flex items-center p-3 rounded-lg shadow-sm ${bgColor} ${textColor} transition-colors duration-300`;
                personElement.innerHTML = `
                    <span class="text-xl mr-4">${emoji}</span>
                    <span class="font-medium">${employee.name}</span>
                `;
                noDeskList.appendChild(personElement);
            });
        }

        function updateAllViews(date) {
            updatePlan(date);
            updateNoDeskList(date);
        }

        async function handleRefresh() {
            refreshButton.disabled = true;
            refreshButton.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Chargement...`;
            if (await fetchAndProcessData()) {
                updateAllViews(dateFilter.value);
            }
            refreshButton.disabled = false;
            refreshButton.innerHTML = `Actualis√© ‚úì`;
            refreshButton.classList.replace('bg-indigo-600', 'bg-emerald-600');
            setTimeout(() => {
                refreshButton.innerHTML = originalRefreshButtonContent;
                refreshButton.classList.replace('bg-emerald-600', 'bg-indigo-600');
            }, 2000); 
        }

        function changeDate(days) {
            const currentDate = new Date(dateFilter.value + 'T12:00:00');
            currentDate.setDate(currentDate.getDate() + days);
            const newDateString = currentDate.toISOString().split('T')[0];
            dateFilter.value = newDateString;
            localStorage.setItem('selectedDate', newDateString); 
            updateAllViews(newDateString);
        }

        // --- √âV√âNEMENTS ---
        prevDayButton.addEventListener('click', () => changeDate(-1));
        nextDayButton.addEventListener('click', () => changeDate(1));
        refreshButton.addEventListener('click', handleRefresh);
        dateFilter.addEventListener('change', (event) => {
            updateAllViews(event.target.value);
            localStorage.setItem('selectedDate', event.target.value); 
        });

        document.addEventListener('DOMContentLoaded', async () => {
            seatingPlan.innerHTML = ''; // Clear initial content
            seatingPlan.appendChild(loaderContainer);
            
            if (await fetchAndProcessData()) {
                const savedDate = localStorage.getItem('selectedDate');
                const initialDate = savedDate || new Date().toISOString().split('T')[0];
                dateFilter.value = initialDate;
                updateAllViews(initialDate);
            }
            loaderContainer.remove();
            
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>

